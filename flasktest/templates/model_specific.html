{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>üõ†Ô∏è Model-Specific FPY Report</h2>

    <div class="form-bar">
        <form method="POST" class="form-section">
            <label for="model_name">Model Name:</label>
            <input type="text" name="model_name" id="model_name" value="{{ selected_model }}" required>

            <label for="station_type">Station Type:</label>
            <select name="station_type" id="station_type">
                <option value="BE" {% if station_type == "BE" %}selected{% endif %}>BE</option>
                <option value="FT" {% if station_type == "FT" %}selected{% endif %}>FT</option>
                <option value="ICT" {% if station_type == "ICT" %}selected{% endif %}>ICT</option>
            </select>

            <label for="start_date" title="You can type or pick from calendar">Start Date & Time:</label>
            <input type="datetime-local" name="start_date" id="start_date" value="{{ start_date }}" required placeholder="YYYY-MM-DD HH:MM">

            <label for="end_date" title="You can type or pick from calendar">End Date & Time:</label>
            <input type="datetime-local" name="end_date" id="end_date" value="{{ end_date }}" required placeholder="YYYY-MM-DD HH:MM">

            <label for="rty_goal">RTY Goal (%):</label>
            <input type="number" step="0.1" name="rty_goal" id="rty_goal" value="{{ rty_goal }}" required>

            <button type="submit">üîç View Report</button>
        </form>

        {% if selected_model %}
        <div class="dropdown">
            <button class="dropbtn">üì§ Export Model</button>
            <div class="dropdown-content">
                <a href="/export-excel-model?model_name={{ selected_model }}&station_type={{ station_type }}&start_date={{ start_date }}&end_date={{ end_date }}&rty_goal={{ rty_goal }}">Export as Excel</a>
                <a href="/export-pdf-model?model_name={{ selected_model }}&station_type={{ station_type }}&start_date={{ start_date }}&end_date={{ end_date }}&rty_goal={{ rty_goal }}">Export as PDF</a>
            </div>
        </div>
        {% endif %}
    </div>

    {% if selected_model and data %}
        {% set actual_rty = data[0]["rty"] %}
        {% if actual_rty %}
            {% set actual_rty_val = actual_rty.replace('%', '') | float %}
            {% if actual_rty_val < rty_goal %}
                <div class="alert warning">
                    ‚ö† RTY Not Meeting Goal ‚Äî Actual: {{ actual_rty_val }}%, Goal: {{ rty_goal }}%
                </div>
            {% else %}
                <div class="alert success">
                    ‚úÖ RTY Goal Met ‚Äî Actual: {{ actual_rty_val }}%, Goal: {{ rty_goal }}%
                </div>
            {% endif %}
        {% endif %}
    {% endif %}

    {% if data %}
    <table id="modelTable" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                {% for col in data[0].keys() %}
                <th>{{ col }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr>
                {% for val in row.values() %}
                <td>{{ val }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if failed_stations %}
    <h3>üö® Stations Not Meeting NTF/DER Goals</h3>
    <table id="goalTable" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                <th>Station</th>
                <th>Metric</th>
                <th>Actual (%)</th>
                <th>Goal (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for s in failed_stations %}
            <tr>
                <td>{{ s[0] }}</td>
                <td>{{ s[1] }}</td>
                <td>{{ s[2] }}</td>
                <td>{{ s[3] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if fail_details %}
    <h3>üìä Top Failure Analysis</h3>
    {% for detail in fail_details %}
    <div class="expander">
        <details>
            <summary><strong>{{ detail.station }} ‚Äî {{ detail.metric }} Analysis</strong></summary>
            <p><strong>Actual:</strong> {{ detail.actual }}% | <strong>Goal:</strong> {{ detail.goal }}%</p>

            {% if detail.metric == "NTF" %}
                <h4>üñ•Ô∏è Top 3 Computers & Faults</h4>
                <table class="display nowrap failureTable" style="width:100%">
                    <thead>
                        <tr>
                            <th>Computer Name</th>
                            <th>Qty</th>
                            <th>Top Faults</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp, count in detail.top_computers.items() %}
                        <tr>
                            <td>{{ comp }}</td>
                            <td>{{ count }}</td>
                            <td>
                                {% if detail.top_faults_by_computer[comp] %}
                                    <ul>
                                    {% for fault in detail.top_faults_by_computer[comp] %}
                                        <li>{{ fault[0] }} ‚Üí {{ fault[1] }}</li>
                                    {% endfor %}
                                    </ul>
                                {% else %}
                                    No fault data available.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <h4>üß™ Top 3 Symptoms & Responsibilities</h4>
                <table class="display nowrap failureTable" style="width:100%">
                    <thead>
                        <tr>
                            <th>Symptom</th>
                            <th>Qty</th>
                            <th>Responsibility</th>
                            <th>Qty</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(3) %}
                        <tr>
                            <td>
                                {% if i < detail.top_symptoms|length %}
                                    {{ detail.top_symptoms[i].Symptoms }}
                                {% endif %}
                            </td>
                            <td>
                                {% if i < detail.top_symptoms|length %}
                                    {{ detail.top_symptoms[i].Count }}
                                {% endif %}
                            </td>
                            <td>
                                {% if i < detail.top_responsibilities|length %}
                                    {{ detail.top_responsibilities[i].Responsibility }}
                                {% endif %}
                            </td>
                            <td>
                                {% if i < detail.top_responsibilities|length %}
                                    {{ detail.top_responsibilities[i].Count }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </details>
    </div>
    {% endfor %}
    {% endif %}
</div>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function() {
    $('#modelTable').DataTable({
        scrollX: true,
        responsive: true,
        paging: false,
        searching: false,
        ordering: true
    });

    $('#goalTable').DataTable({
        scrollX: true,
        responsive: true,
        paging: false,
        searching: false,
        ordering: true
    });

    $('.failureTable').DataTable({
        scrollX: true,
        responsive: true,
        paging: false,
        searching: false,
        ordering: true
    });
});
</script>

<style>
input[type="datetime-local"] {
    min-width: 220px;
    padding: 6px 10px;
    font-size: 14px;
}
</style>
{% endblock %}
