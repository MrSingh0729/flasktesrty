{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>üéØ Project-Specific FPY Report</h2>

    <div class="form-bar">
        <form method="POST" class="form-section">
            <label for="project">Select Project:</label>
            <select name="project" id="project" required>
                {% for p in projects %}
                <option value="{{ p }}" {% if p == selected_project %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>

            <label for="rty_goal">RTY Goal (%):</label>
            <input type="number" step="0.1" name="rty_goal" id="rty_goal" value="{{ rty_goal }}" required>

            <button type="submit">üîç View Report</button>
        </form>

        <div class="dropdown">
            <button class="dropbtn">üì§ Export Project</button>
            <div class="dropdown-content">
                <a href="/export-excel?project={{ selected_project }}&rty_goal={{ rty_goal }}">Export as Excel</a>
<a href="/export-pdf?project={{ selected_project }}&rty_goal={{ rty_goal }}">Export as PDF</a>
            </div>
        </div>
    </div>

    {% if selected_project and data %}
        {% set actual_rty = data[0]["rty"] %}
        {% if actual_rty %}
            {% set actual_rty_val = actual_rty.replace('%', '') | float %}
            {% if actual_rty_val < rty_goal %}
                <div class="alert warning">
                    ‚ö† RTY Not Meeting Goal ‚Äî Actual: {{ actual_rty_val }}%, Goal: {{ rty_goal }}%
                </div>
            {% else %}
                <div class="alert success">
                    ‚úÖ RTY Goal Met ‚Äî Actual: {{ actual_rty_val }}%, Goal: {{ rty_goal }}%
                </div>
            {% endif %}
        {% endif %}
    {% endif %}

    {% if data %}
    <table id="projectTable" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                {% for col in data[0].keys() %}
                <th>{{ col }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr>
                {% for val in row.values() %}
                <td>{{ val }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if failed_stations %}
    <h3>üö® Stations Not Meeting NTF/DER Goals</h3>
    <table id="goalTable" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                <th>Station</th>
                <th>Metric</th>
                <th>Actual (%)</th>
                <th>Goal (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for s in failed_stations %}
            <tr>
                <td>{{ s[0] }}</td>
                <td>{{ s[1] }}</td>
                <td>{{ s[2] }}</td>
                <td>{{ s[3] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if fail_details %}
    <h3>üìä Top Failure Analysis</h3>
    {% for detail in fail_details %}
    <div class="expander">
        <details>
            <summary><strong>{{ detail.station }} ‚Äî {{ detail.metric }} Analysis</strong></summary>
            <p><strong>Actual:</strong> {{ detail.actual }}% | <strong>Goal:</strong> {{ detail.goal }}%</p>

            {% if detail.metric == "NTF" %}
                <h4>üñ•Ô∏è Top 3 Computers & Faults</h4>
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th>Top Computer ‚Üí Qty</th>
                            <th>Top 3 Faults ‚Üí Qty</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp, count in detail.top_computers.items() %}
                        <tr>
                            <td>{{ comp }} ‚Üí {{ count }}</td>
                            <td>
                                {% if detail.top_faults_by_computer[comp] %}
                                    {% for fault in detail.top_faults_by_computer[comp] %}
                                        {{ loop.index }}. {{ fault[0] }} ‚Üí {{ fault[1] }}<br>
                                    {% endfor %}
                                {% else %}
                                    No fault data available.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <h4>üß™ Top 3 Symptoms & Responsibilities</h4>
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th>Symptom ‚Üí Qty</th>
                            <th>Responsibility ‚Üí Qty</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(3) %}
                        <tr>
                            <td>
                                {% if i < detail.top_symptoms|length %}
                                    {{ detail.top_symptoms[i].Symptoms }} ‚Üí {{ detail.top_symptoms[i].Count }}
                                {% endif %}
                            </td>
                            <td>
                                {% if i < detail.top_responsibilities|length %}
                                    {{ detail.top_responsibilities[i].Responsibility }} ‚Üí {{ detail.top_responsibilities[i].Count }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </details>
    </div>
    {% endfor %}
    {% endif %}
</div>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function() {
    $('#projectTable').DataTable({
        scrollX: true,
        responsive: true,
        paging: false,
        searching: false,
        ordering: true
    });

    $('#goalTable').DataTable({
        scrollX: true,
        responsive: true,
        paging: false,
        searching: false,
        ordering: true
    });
});
</script>

<style>
.form-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    gap: 20px;
    margin-bottom: 15px;
}

.form-section {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}

.form-section label {
    font-weight: bold;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropbtn {
    background-color: #0078d4;
    color: white;
    padding: 8px 16px;
    font-size: 14px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 4px 8px rgba(0,0,0,0.1);
    z-index: 1;
    border-radius: 4px;
    overflow: hidden;
}

.dropdown-content a {
    color: black;
    padding: 10px 16px;
    text-decoration: none;
    display: block;
    font-size: 14px;
}

.dropdown-content a:hover {
    background-color: #f1f1f1;
}

.dropdown:hover .dropdown-content {
    display: block;
}

.dropdown:hover .dropbtn {
    background-color: #005a9e;
}

.expander details {
    margin: 20px 0;
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background-color: #f9f9f9;
}

.expander summary {
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
}

.excel-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 10px;
}

.excel-table th, .excel-table td {
    border: 1px solid #ccc;
    padding: 8px 12px;
    text-align: left;
    vertical-align: top;
}

.excel-table th {
    background-color: #e0e0e0;
    font-weight: bold;
}

.excel-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.excel-table tr:hover {
    background-color: #f1f1f1;
}

.alert.success {
    background-color: #e6ffed;
    border-left: 4px solid #2ecc71;
    padding: 10px;
    margin: 15px 0;
}

.alert.warning {
    background-color: #fff3cd;
    border-left: 4px solid #f39c12;
    padding: 10px;
    margin: 15px 0;
}
</style>
{% endblock %}
